name: Memecoin Pre-Viral Scanner

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: memecoin-previral
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      CHAINS: "solana,base,bsc"
      TOP: "20"
      ONLY_QUOTES: "USDC,SOL,WETH,USDT,USD1"
      AGE_MIN: "2"
      AGE_MAX: "120"
      MIN_LIQ: "30000"
      MAX_LIQ: "300000"
      ABS_VOL24: "30000"
      MIN_TURNOVER: "0.003"
      MIN_BUYS5M: "0.60"
      MIN_TXNS1H: "20"
      MIN_TXNS5M: "2"
      MEME_ONLY: "true"
      ALERT_THRESHOLD: "0.45"
      ALERT_ACCEL: "1.2"
      ALERT_BUYS: "0.6"
      COOLDOWN_HOURS: "6"
      DEBUG: "false"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run scanner & persist
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          BIRDEYE_API_KEY:    ${{ secrets.BIRDEYE_API_KEY }}
        run: |
          set -e
          TS=$(date -u +"%Y%m%d_%H%M%S")
          mkdir -p runs data
          python memecoin_previral.py \
            --chains "${CHAINS}" \
            --top "${TOP}" \
            $([ "${MEME_ONLY}" = "true" ] && echo "--meme-only" || true) \
            --age-min "${AGE_MIN}" --age-max "${AGE_MAX}" \
            --min-liquidity "${MIN_LIQ}" --max-liquidity "${MAX_LIQ}" \
            --abs-vol24-floor "${ABS_VOL24}" --min-turnover-ratio "${MIN_TURNOVER}" \
            --min-buys5m "${MIN_BUYS5M}" --min-txns1h "${MIN_TXNS1H}" --min-txns5m "${MIN_TXNS5M}" \
            --only-quotes "${ONLY_QUOTES}" \
            --alert-threshold "${ALERT_THRESHOLD}" \
            --alert-accel "${ALERT_ACCEL}" \
            --alert-buys "${ALERT_BUYS}" \
            --cooldown-hours "${COOLDOWN_HOURS}" \
            ${BIRDEYE_API_KEY:+--birdeye-key "${BIRDEYE_API_KEY}"} \
            $([ "${DEBUG}" = "true" ] && echo "--debug" || true) \
            --debug\
          | tee "runs/scan_${TS}.log"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: memecoin-scanner-${{ github.run_number }}
          path: |
            runs/
            data/*.csv
