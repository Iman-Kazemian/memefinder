name: Memecoin Pre-Viral Scanner

on:
  schedule:
    - cron: "*/5 * * * *"   # run every 5 minutes (UTC)
  workflow_dispatch: {}

permissions:
  contents: write   # needed to commit the cooldown cache
  actions: read

concurrency:
  group: memecoin-previral
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      CHAINS: "solana,base"
      ONLY_QUOTES: "USDC,SOL,WETH,USDT,USD1,VIRTUAL"
      TOP: "100"
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT:  ${{ secrets.TELEGRAM_CHAT }}
      BIRDEYE_API_KEY: ${{ secrets.BIRDEYE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git identity
        run: |
          git config user.name "previral-bot"
          git config user.email "previral-bot@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy

      - name: Run scanner
        run: |
          TS=$(date -u +"%Y%m%d_%H%M%S")
          mkdir -p runs .state
          python memecoin_previral.py \
            --chains "${CHAINS}" \
            --top "${TOP}" \
            --age-min 0.3 --age-max 6 \
            --min-liquidity 30000 --max-liquidity 400000 \
            --min-vol24 20000 \
            --abs-vol24-floor 15000 \
            --min-turnover-ratio 0.04 \
            --min-buys5m 0.58 \
            --min-txns1h 20 \
            --min-txns5m 4 \
            --only-quotes "${ONLY_QUOTES}" \
            --exclude-dex "pumpswap" \
            --meme-only \
            --alert-threshold 0.60 \
            --alert-accel 1.3 \
            --alert-buys 0.65 \
            --debug | tee "runs/scan_${TS}.log"

      - name: Commit cooldown cache
        run: |
          if [ -n "$(git status --porcelain .state/alert_cache.json 2>/dev/null)" ]; then
            git add .state/alert_cache.json
            git commit -m "chore: update alert cooldown cache"
            git push
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: memecoin-scans
          path: runs/
          retention-days: 14
